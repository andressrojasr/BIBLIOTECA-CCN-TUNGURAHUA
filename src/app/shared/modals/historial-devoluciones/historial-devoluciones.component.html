<app-header title="Historial de Devoluciones" [isModal]="true"></app-header>
<ion-content [fullscreen]="true">
  <div class="modal-content">
    <!-- Buscador -->
    <div class="search-section">
      <ion-searchbar 
        mode="ios" 
        animated="true" 
        placeholder="Buscar por usuario o libro" 
        [(ngModel)]="searchTerm" 
        (ionInput)="filterHistorial()"
        clearOnEdit="true">
      </ion-searchbar>
    </div>

    <!-- Lista del historial -->
    <ion-list *ngIf="filteredHistorial.length > 0">
      <ion-list-header>
        <ion-label>
          Devoluciones Registradas
          <span class="results-count" *ngIf="searchTerm.trim() !== ''">
            ({{ filteredHistorial.length }} resultado{{ filteredHistorial.length !== 1 ? 's' : '' }})
          </span>
        </ion-label>
      </ion-list-header>
      
      <ion-item *ngFor="let item of filteredHistorial" class="historial-item">
        <ion-label class="historial-label">
          <div class="usuario-info">
            <h2 class="usuario-nombre">
              <ion-icon name="person-outline"></ion-icon>
              {{ item.usuarioNombres }} {{ item.usuarioApellidos }}
            </h2>
          </div>
          
          <div class="libros-devueltos">
            <div class="libros-header">
              <ion-icon name="library-outline"></ion-icon>
              <span>Libro{{ item.librosDevueltos?.length > 1 ? 's' : '' }} devuelto{{ item.librosDevueltos?.length > 1 ? 's' : '' }}:</span>
            </div>
            <div class="libros-list">
              <div *ngFor="let libro of item.librosDevueltos" class="libro-item">
                <h3>{{ libro.titulo }}</h3>
                <p class="codigo-libro">Código: {{ libro.codigo }}</p>
              </div>
            </div>
          </div>
          
          <div class="fechas-info">
            <p class="fecha-prestamo">
              <ion-icon name="calendar-outline"></ion-icon>
              Préstamo: {{ item.fechaPrestamo | date:'dd/MM/yyyy' }}
            </p>
            <p class="fecha-devolucion">
              <ion-icon name="checkmark-circle-outline"></ion-icon>
              Devolución: {{ item.fechaDevolucion | date:'dd/MM/yyyy' }}
            </p>
          </div>
          
          <!-- Información adicional del préstamo -->
          <div class="prestamo-info" *ngIf="item.totalLibrosPrestamo && item.totalLibrosPrestamo > item.librosDevueltos?.length">
            <p class="info-prestamo">
              <ion-icon name="information-circle-outline"></ion-icon>
              Préstamo original: {{ item.totalLibrosPrestamo }} libro{{ item.totalLibrosPrestamo > 1 ? 's' : '' }}
              ({{ item.librosDevueltos?.length }} devuelto{{ item.librosDevueltos?.length > 1 ? 's' : '' }} en esta fecha)
            </p>
          </div>
        </ion-label>
      </ion-item>
    </ion-list>

    <!-- Estado vacío -->
    <div *ngIf="filteredHistorial.length === 0 && !isProcessing" class="empty-state">
      <ion-icon name="library-outline" class="empty-icon"></ion-icon>
      <ion-text color="medium">
        <h3 *ngIf="searchTerm.trim() === ''">No hay devoluciones registradas</h3>
        <h3 *ngIf="searchTerm.trim() !== ''">No se encontraron resultados para "{{ searchTerm }}"</h3>
        <p *ngIf="searchTerm.trim() !== ''">Intenta con otro término de búsqueda</p>
      </ion-text>
    </div>

    <!-- Spinner de carga -->
    <div *ngIf="isProcessing" class="loading-state">
      <ion-spinner name="crescent"></ion-spinner>
      <ion-text color="medium">
        <p>Cargando historial...</p>
      </ion-text>
    </div>
  </div>
</ion-content>